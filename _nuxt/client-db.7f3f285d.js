import{a as y,p as d,c as h,m as v,b as _}from"./pipeline.795217dc.js";import{ay as b,m as f,a0 as l,al as C,k as $}from"./entry.e2768eba.js";function p(a){const i=y(a);return async t=>{var n;const o=t.params(),e=await i(t);return o.surround?e==null?void 0:e.surround:(e!=null&&e.dirConfig&&(e.result={_path:(n=e.dirConfig)==null?void 0:n._path,...e.result,_dir:e.dirConfig}),e==null?void 0:e.result)}}const I=a=>C(a,f().public.content.api.baseURL),P=d(h({driver:v()}),"@content");function k(a){async function i(){const t=new Set(await a.getKeys("cache:")),o=l().getPreviewToken();if(o){const n=await a.getItem(`${o}$`).then(r=>r||{});if(Array.isArray(n.ignoreSources)){const r=n.ignoreSources.map(c=>`cache:${c.trim()}:`);for(const c of t)r.some(w=>c.startsWith(w))&&t.delete(c)}const s=await a.getKeys(`${o}:`),u=await Promise.all(s.map(r=>a.getItem(r)));for(const r of u)t.delete(`cache:${r._id}`),r.__deleted||t.add(`${o}:${r._id}`)}return await Promise.all(Array.from(t).map(n=>a.getItem(n)))}return{storage:a,fetch:p(i),query:t=>b(p(i),{initialParams:t,legacy:!0})}}let m=null,g=null;async function D(){return g?await g:m||(g=S(),m=await g),m}async function S(){const a=$(),{content:i}=f().public,t=k(P),o=await t.storage.getItem("integrity");if(i.integrity!==+(o||0)){const{contents:e,navigation:n}=await $fetch(I(i.integrity?`cache.${i.integrity}.json`:"cache.json"));await Promise.all(e.map(s=>t.storage.setItem(`cache:${s._id}`,s))),await t.storage.setItem("navigation",n),await t.storage.setItem("integrity",i.integrity)}return await a.callHook("content:storage",t.storage),t}async function x(a){const i=await D();if(!l().getPreviewToken()&&Object.keys(a||{}).length===0)return i.storage.getItem("navigation");const t=await i.query(a).where({_partial:!1,navigation:{$ne:!1}}).find(),e=(await i.query().where({_path:/\/_dir$/i,_partial:!0}).find()).reduce((n,s)=>{var r;((r=s.title)==null?void 0:r.toLowerCase())==="dir"&&(s.title=void 0);const u=s._path.split("/").slice(0,-1).join("/")||"/";return n[u]={...s,...s.body},n},{});return _(t,e)}export{P as contentStorage,k as createDB,x as generateNavigation,D as useContentDatabase};
